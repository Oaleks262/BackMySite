// üìÅ utils/generatePDF.js
const fs = require('fs');
const PDFDocument = require('pdfkit');
const path = require('path');
const { getContractTemplate, getWarrantyTerms, getMaintenanceTerms } = require('./contractTemplates');

const getTariffPrice = (tariffType) => {
  const prices = {
    'single': 5000,
    'landing': 8000,
    'blog': 12000
  };
  return prices[tariffType] || 0;
};

const getTariffName = (tariffType) => {
  const names = {
    'single': '–û–¥–Ω–æ—Å—Ç–æ—Ä—ñ–Ω–∫–æ–≤–∏–π —Å–∞–π—Ç',
    'landing': '–õ–µ–Ω–¥—ñ–Ω–≥',
    'blog': '–ë–∞–≥–∞—Ç–æ—Å—Ç–æ—Ä—ñ–Ω–∫–æ–≤–∏–π —Å–∞–π—Ç –∑ –±–ª–æ–≥–æ–º'
  };
  return names[tariffType] || '–í–µ–±-—Å–∞–π—Ç';
};

const formatDate = (date) => {
  return new Date(date).toLocaleDateString('uk-UA');
};

const addDays = (date, days) => {
  const result = new Date(date);
  result.setDate(result.getDate() + days);
  return result;
};

const generatePDF = async (order) => {
  const doc = new PDFDocument();
  const pdfDir = path.join(__dirname, '../public/pdfs');
  const contractVersion = order.contractVersion || 1;
  const filePath = path.join(pdfDir, `contract_${order._id}_v${contractVersion}.pdf`);
  
  // –°—Ç–≤–æ—Ä–∏—Ç–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é —è–∫—â–æ –Ω–µ —ñ—Å–Ω—É—î
  if (!fs.existsSync(pdfDir)) {
    fs.mkdirSync(pdfDir, { recursive: true });
  }
  
  const writeStream = fs.createWriteStream(filePath);

  // ‚úÖ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —à—Ä–∏—Ñ—Ç—É –∑ –∫–∏—Ä–∏–ª–∏—Ü–µ—é
  doc.registerFont('DejaVu', path.join(__dirname, 'fonts/DejaVuSans.ttf'));
  doc.font('DejaVu');

  doc.pipe(writeStream);

  const contractDate = new Date();
  const projectPrice = order.amount || getTariffPrice(order.tariffType);
  const startDate = addDays(contractDate, 1);
  const endDate = addDays(startDate, order.tariffType === 'blog' ? 30 : order.tariffType === 'landing' ? 21 : 14);
  const prepayment = Math.round(projectPrice * 0.3);
  const finalPayment = projectPrice - prepayment;
  
  doc.fontSize(18).text('–¶–ò–í–Ü–õ–¨–ù–û-–ü–†–ê–í–û–í–ò–ô –î–û–ì–û–í–Ü–†', { align: 'center' });
  doc.fontSize(16).text('–ø—Ä–æ –Ω–∞–¥–∞–Ω–Ω—è –ø–æ—Å–ª—É–≥ –∑ —Ä–æ–∑—Ä–æ–±–∫–∏ –≤–µ–±-—Å–∞–π—Ç—É', { align: 'center' });
  doc.fontSize(14).text('‚Ññ ' + order._id.slice(-6), { align: 'center' });
  doc.moveDown();

  doc.fontSize(12).text(`–º. –õ—å–≤—ñ–≤                                                            "${formatDate(contractDate)}"`, { align: 'left' });
  doc.moveDown();

  doc.text(`–ó–≤—ñ—Ä–∏—á –û–ª–µ–∫—Å–∞–Ω–¥—Ä –ú–∏–∫–æ–ª–∞–π–æ–≤–∏—á, —Ñ—ñ–∑–∏—á–Ω–∞ –æ—Å–æ–±–∞, –ø–∞—Å–ø–æ—Ä—Ç —Å–µ—Ä—ñ—è –í–í ‚Ññ 123456, –≤–∏–¥–∞–Ω–∏–π 01.01.2020 –õ—å–≤—ñ–≤—Å—å–∫–∏–º –ú–í –£–ú–í–° –£–∫—Ä–∞—ó–Ω–∏ —É –õ—å–≤—ñ–≤—Å—å–∫—ñ–π –æ–±–ª–∞—Å—Ç—ñ, –∫–æ–¥ –†–ù–û–ö–ü–ü: 1234567890, –Ω–∞–¥–∞–ª—ñ "–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å", –∑ –æ–¥–Ω—ñ—î—ó —Å—Ç–æ—Ä–æ–Ω–∏, —Ç–∞

${order.user.firstName} ${order.user.lastName}, —Ñ—ñ–∑–∏—á–Ω–∞ –æ—Å–æ–±–∞, –Ω–∞–¥–∞–ª—ñ "–ó–∞–º–æ–≤–Ω–∏–∫", –∑ —ñ–Ω—à–æ—ó —Å—Ç–æ—Ä–æ–Ω–∏,

—É–∫–ª–∞–ª–∏ —Ü–µ–π —Ü–∏–≤—ñ–ª—å–Ω–æ-–ø—Ä–∞–≤–æ–≤–∏–π –¥–æ–≥–æ–≤—ñ—Ä –ø—Ä–æ –Ω–∞—Å—Ç—É–ø–Ω–µ:`);

  doc.moveDown();
  doc.text('1. –ü–†–ï–î–ú–ï–¢ –î–û–ì–û–í–û–†–£');
  
  const template = getContractTemplate(order.tariffType);
  
  doc.text(`1.1. –í–∏–∫–æ–Ω–∞–≤–µ—Ü—å –∑–æ–±–æ–≤'—è–∑—É—î—Ç—å—Å—è –≤–∏–∫–æ–Ω–∞—Ç–∏ —Ä–æ–±–æ—Ç–∏ –∑ ${template.workDescription}.`);
  doc.text(`1.2. –¢–∏–ø –ø—Ä–æ–µ–∫—Ç—É: ${getTariffName(order.tariffType)}`);
  if (order.selectedTemplate) {
    doc.text(`1.3. –û–±—Ä–∞–Ω–∏–π —à–∞–±–ª–æ–Ω: ${order.selectedTemplate}`);
  }

  doc.moveDown();
  doc.text('1.4. –§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω—ñ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ:');
  template.features.forEach((feature, index) => {
    doc.text(`    ${index + 1}. ${feature}`);
  });

  doc.moveDown();
  doc.text('1.5. –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ —Ä–æ–±–æ—Ç–∏:');
  template.deliverables.forEach((deliverable, index) => {
    doc.text(`    ${index + 1}. ${deliverable}`);
  });

  // –î–æ–¥–∞—î–º–æ —Å–ø–µ—Ü–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –∑ –±–ª–æ–∫—ñ–≤
  if (order.blocks && Object.keys(order.blocks).length > 0) {
    doc.moveDown();
    doc.text('1.6. –î–æ–¥–∞—Ç–∫–æ–≤—ñ —Å–ø–µ—Ü–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –ø—Ä–æ–µ–∫—Ç—É:');
    Object.entries(order.blocks).forEach(([blockName, blockData]) => {
      if (blockData && typeof blockData === 'object') {
        doc.text(`    - ${blockName}:`);
        if (blockData.title) doc.text(`      –ó–∞–≥–æ–ª–æ–≤–æ–∫: ${blockData.title}`);
        if (blockData.content) doc.text(`      –ö–æ–Ω—Ç–µ–Ω—Ç: ${blockData.content.substring(0, 100)}${blockData.content.length > 100 ? '...' : ''}`);
        if (blockData.text) doc.text(`      –¢–µ–∫—Å—Ç: ${blockData.text.substring(0, 100)}${blockData.text.length > 100 ? '...' : ''}`);
        if (blockData.items && Array.isArray(blockData.items)) {
          doc.text(`      –ï–ª–µ–º–µ–Ω—Ç–∏: ${blockData.items.length} –ø—É–Ω–∫—Ç—ñ–≤`);
        }
      }
    });
  }

  doc.moveDown();
  doc.text('2. –°–¢–†–û–ö–ò –í–ò–ö–û–ù–ê–ù–ù–Ø');
  doc.text(`2.1. –î–∞—Ç–∞ –ø–æ—á–∞—Ç–∫—É —Ä–æ–±—ñ—Ç: ${formatDate(startDate)}`);
  doc.text(`2.2. –î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è —Ä–æ–±—ñ—Ç: ${formatDate(endDate)}`);
  doc.text('2.3. –°—Ç—Ä–æ–∫–∏ –º–æ–∂—É—Ç—å –±—É—Ç–∏ —Å–∫–æ—Ä–∏–≥–æ–≤–∞–Ω—ñ –∑–∞ –¥–æ–º–æ–≤–ª–µ–Ω—ñ—Å—Ç—é —Å—Ç–æ—Ä—ñ–Ω.');

  doc.moveDown();
  doc.text('3. –í–ê–†–¢–Ü–°–¢–¨ –¢–ê –û–ü–õ–ê–¢–ê');
  doc.text(`3.1. –ó–∞–≥–∞–ª—å–Ω–∞ –≤–∞—Ä—Ç—ñ—Å—Ç—å —Ä–æ–±—ñ—Ç: ${projectPrice.toLocaleString('uk-UA')} –≥—Ä–Ω.`);
  doc.text(`3.2. –ü–µ—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ (30%): ${prepayment.toLocaleString('uk-UA')} –≥—Ä–Ω.`);
  doc.text(`3.3. –î–æ–ø–ª–∞—Ç–∞ –ø—ñ—Å–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è —Ä–æ–±—ñ—Ç (70%): ${finalPayment.toLocaleString('uk-UA')} –≥—Ä–Ω.`);
  doc.text('3.4. –ü–µ—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ –≤–Ω–æ—Å–∏—Ç—å—Å—è –ø—Ä–æ—Ç—è–≥–æ–º 3 –¥–Ω—ñ–≤ –ø—ñ—Å–ª—è –ø—ñ–¥–ø–∏—Å–∞–Ω–Ω—è –¥–æ–≥–æ–≤–æ—Ä—É.');
  doc.text('3.5. –î–æ–ø–ª–∞—Ç–∞ –≤–Ω–æ—Å–∏—Ç—å—Å—è –ø—Ä–æ—Ç—è–≥–æ–º 5 –¥–Ω—ñ–≤ –ø—ñ—Å–ª—è –∑–¥–∞—á—ñ —Ä–æ–±—ñ—Ç.');

  doc.moveDown();
  doc.text('4. –ü–†–ê–í–ê –¢–ê –û–ë–û–í\'–Ø–ó–ö–ò –°–¢–û–†–Ü–ù');
  
  doc.text('4.1. –û–ë–û–í\'–Ø–ó–ö–ò –í–ò–ö–û–ù–ê–í–¶–Ø:');
  doc.text('    - –≤–∏–∫–æ–Ω–∞—Ç–∏ —Ä–æ–±–æ—Ç–∏ —è–∫—ñ—Å–Ω–æ —Ç–∞ –≤ —Å—Ç—Ä–æ–∫;');
  doc.text('    - –¥–æ—Ç—Ä–∏–º—É–≤–∞—Ç–∏—Å—è —Ç–µ—Ö–Ω—ñ—á–Ω–∏—Ö –≤–∏–º–æ–≥ —Ç–∞ –ø–æ–±–∞–∂–∞–Ω—å –ó–∞–º–æ–≤–Ω–∏–∫–∞;');
  doc.text('    - –∑–∞–±–µ–∑–ø–µ—á–∏—Ç–∏ –∫–æ–Ω—Ñ—ñ–¥–µ–Ω—Ü—ñ–π–Ω—ñ—Å—Ç—å –ø–µ—Ä–µ–¥–∞–Ω–∏—Ö –¥–∞–Ω–∏—Ö;');
  doc.text('    - –Ω–∞–¥–∞—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ä–æ–±–æ—Ç–∏ —É –ø–æ–≤–Ω–æ–º—É –æ–±—Å—è–∑—ñ.');
  
  doc.text('4.2. –ü–†–ê–í–ê –í–ò–ö–û–ù–ê–í–¶–Ø:');
  doc.text('    - –≤–∏–º–∞–≥–∞—Ç–∏ —Å–≤–æ—î—á–∞—Å–Ω–æ—ó –æ–ø–ª–∞—Ç–∏ –≤–∏–∫–æ–Ω–∞–Ω–∏—Ö —Ä–æ–±—ñ—Ç;');
  doc.text('    - –∑–∞–ø–∏—Ç—É–≤–∞—Ç–∏ —É –ó–∞–º–æ–≤–Ω–∏–∫–∞ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏ —Ç–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é;');
  doc.text('    - –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Å—Ç–≤–æ—Ä–µ–Ω–∏–π —Å–∞–π—Ç —É –ø–æ—Ä—Ç—Ñ–æ–ª—ñ–æ (–±–µ–∑ –∫–æ–Ω—Ñ—ñ–¥–µ–Ω—Ü—ñ–π–Ω–∏—Ö –¥–∞–Ω–∏—Ö).');
  
  doc.text('4.3. –û–ë–û–í\'–Ø–ó–ö–ò –ó–ê–ú–û–í–ù–ò–ö–ê:');
  doc.text('    - —Å–≤–æ—î—á–∞—Å–Ω–æ –æ–ø–ª–∞—á—É–≤–∞—Ç–∏ –≤–∏–∫–æ–Ω–∞–Ω—ñ —Ä–æ–±–æ—Ç–∏;');
  doc.text('    - –Ω–∞–¥–∞–≤–∞—Ç–∏ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏ —Ç–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é;');
  doc.text('    - —Å–≤–æ—î—á–∞—Å–Ω–æ —Ä–æ–∑–≥–ª—è–¥–∞—Ç–∏ —Ç–∞ –ø–æ–≥–æ–¥–∂—É–≤–∞—Ç–∏ –µ—Ç–∞–ø–∏ —Ä–æ–±–æ—Ç–∏.');
  
  doc.text('4.4. –ü–†–ê–í–ê –ó–ê–ú–û–í–ù–ò–ö–ê:');
  doc.text('    - –≤–∏–º–∞–≥–∞—Ç–∏ —è–∫—ñ—Å–Ω–æ–≥–æ —Ç–∞ —Å–≤–æ—î—á–∞—Å–Ω–æ–≥–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è —Ä–æ–±—ñ—Ç;');
  doc.text('    - –≤–Ω–æ—Å–∏—Ç–∏ –æ–±“ë—Ä—É–Ω—Ç–æ–≤–∞–Ω—ñ –∑–º—ñ–Ω–∏ –¥–æ —Ç–µ—Ö–Ω—ñ—á–Ω–æ–≥–æ –∑–∞–≤–¥–∞–Ω–Ω—è.');

  doc.moveDown();
  doc.text('5. –ì–ê–†–ê–ù–¢–Ü–á –¢–ê –ü–Ü–î–¢–†–ò–ú–ö–ê');
  const warranty = getWarrantyTerms(order.tariffType);
  const maintenance = getMaintenanceTerms(order.tariffType);
  doc.text(`5.1. –ì–∞—Ä–∞–Ω—Ç—ñ–π–Ω–∏–π –ø–µ—Ä—ñ–æ–¥: ${warranty.period}`);
  doc.text(`5.2. –ì–∞—Ä–∞–Ω—Ç—ñ—è –ø–æ–∫—Ä–∏–≤–∞—î: ${warranty.coverage}`);
  doc.text(`5.3. –í–∫–ª—é—á–µ–Ω–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∞: ${maintenance.included}`);
  doc.text(`5.4. –î–æ–¥–∞—Ç–∫–æ–≤—ñ –ø–æ—Å–ª—É–≥–∏: ${maintenance.optional}`);

  doc.moveDown();
  doc.text('6. –§–û–†–°-–ú–ê–ñ–û–†');
  doc.text('6.1. –°—Ç–æ—Ä–æ–Ω–∏ –∑–≤—ñ–ª—å–Ω—è—é—Ç—å—Å—è –≤—ñ–¥ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–æ—Å—Ç—ñ –∑–∞ —á–∞—Å—Ç–∫–æ–≤–µ –∞–±–æ –ø–æ–≤–Ω–µ –Ω–µ–≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∑–æ–±–æ–≤\'—è–∑–∞–Ω—å –∑–∞ —Ü–∏–º –¥–æ–≥–æ–≤–æ—Ä–æ–º —É —Ä–∞–∑—ñ –Ω–∞—Å—Ç–∞–Ω–Ω—è —Ñ–æ—Ä—Å-–º–∞–∂–æ—Ä–Ω–∏—Ö –æ–±—Å—Ç–∞–≤–∏–Ω.');
  doc.text('6.2. –î–æ —Ñ–æ—Ä—Å-–º–∞–∂–æ—Ä–Ω–∏—Ö –æ–±—Å—Ç–∞–≤–∏–Ω –Ω–∞–ª–µ–∂–∞—Ç—å: –ø–æ–∂–µ–∂—ñ, –ø–æ–≤–µ–Ω—ñ, –∑–µ–º–ª–µ—Ç—Ä—É—Å–∏, –≤—ñ–π–Ω–∞, —Å—Ç—Ä–∞–π–∫–∏, –∞–∫—Ç–∏ –¥–µ—Ä–∂–∞–≤–Ω–∏—Ö –æ—Ä–≥–∞–Ω—ñ–≤ —Ç–æ—â–æ.');
  doc.text('6.3. –°—Ç–æ—Ä–æ–Ω–∞, —è–∫–∞ –Ω–µ –º–æ–∂–µ –≤–∏–∫–æ–Ω–∞—Ç–∏ —Å–≤–æ—ó –∑–æ–±–æ–≤\'—è–∑–∞–Ω–Ω—è, –ø–æ–≤–∏–Ω–Ω–∞ –ø–∏—Å—å–º–æ–≤–æ –ø–æ–≤—ñ–¥–æ–º–∏—Ç–∏ —ñ–Ω—à—É —Å—Ç–æ—Ä–æ–Ω—É –ø—Ä–æ—Ç—è–≥–æ–º 5 –¥–Ω—ñ–≤.');

  doc.moveDown();
  doc.text('7. –ö–û–ù–§–Ü–î–ï–ù–¶–Ü–ô–ù–Ü–°–¢–¨');
  doc.text('7.1. –°—Ç–æ—Ä–æ–Ω–∏ –∑–æ–±–æ–≤\'—è–∑—É—é—Ç—å—Å—è –∑–±–µ—Ä—ñ–≥–∞—Ç–∏ –∫–æ–Ω—Ñ—ñ–¥–µ–Ω—Ü—ñ–π–Ω—ñ—Å—Ç—å –æ—Ç—Ä–∏–º–∞–Ω–æ—ó –≤ –ø—Ä–æ—Ü–µ—Å—ñ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è —Ü—å–æ–≥–æ –î–æ–≥–æ–≤–æ—Ä—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó.');

  doc.moveDown();
  doc.text('8. –í–Ü–î–ü–û–í–Ü–î–ê–õ–¨–ù–Ü–°–¢–¨ –°–¢–û–†–Ü–ù');
  doc.text('8.1. –ó–∞ –Ω–µ—Å–≤–æ—î—á–∞—Å–Ω–µ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∑–æ–±–æ–≤\'—è–∑–∞–Ω—å —Å—Ç–æ—Ä–æ–Ω–∏ –Ω–µ—Å—É—Ç—å –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω—ñ—Å—Ç—å –∑–≥—ñ–¥–Ω–æ –∑ –¶–∏–≤—ñ–ª—å–Ω–∏–º –∫–æ–¥–µ–∫—Å–æ–º –£–∫—Ä–∞—ó–Ω–∏.');
  doc.text('8.2. –£ —Ä–∞–∑—ñ –∑–∞—Ç—Ä–∏–º–∫–∏ –æ–ø–ª–∞—Ç–∏ –ó–∞–º–æ–≤–Ω–∏–∫–æ–º –ø–æ–Ω–∞–¥ 10 –¥–Ω—ñ–≤, –í–∏–∫–æ–Ω–∞–≤–µ—Ü—å –º–∞—î –ø—Ä–∞–≤–æ –ø—Ä–∏–∑—É–ø–∏–Ω–∏—Ç–∏ —Ä–æ–±–æ—Ç–∏.');
  doc.text('8.3. –£ —Ä–∞–∑—ñ –∑–∞—Ç—Ä–∏–º–∫–∏ –∑–¥–∞—á—ñ —Ä–æ–±—ñ—Ç –∑ –≤–∏–Ω–∏ –í–∏–∫–æ–Ω–∞–≤—Ü—è –ø–æ–Ω–∞–¥ 7 –¥–Ω—ñ–≤, –ó–∞–º–æ–≤–Ω–∏–∫ –º–∞—î –ø—Ä–∞–≤–æ –≤–∏–º–∞–≥–∞—Ç–∏ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –ø–µ—Ä–µ–¥–æ–ø–ª–∞—Ç–∏.');
  doc.text('8.4. –°—Ç–æ—Ä–æ–Ω–∏ –∑–≤—ñ–ª—å–Ω—è—é—Ç—å—Å—è –≤—ñ–¥ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–æ—Å—Ç—ñ —É —Ä–∞–∑—ñ –¥—ñ—ó –æ–±—Å—Ç–∞–≤–∏–Ω –Ω–µ–ø–µ—Ä–µ–±–æ—Ä–Ω–æ—ó —Å–∏–ª–∏.');

  doc.moveDown();
  doc.text('9. –ï–õ–ï–ö–¢–†–û–ù–ù–Ü –ü–Ü–î–ü–ò–°–ò');
  doc.text('9.1. –î–∞–Ω–∏–π –¥–æ–≥–æ–≤—ñ—Ä –º–æ–∂–µ –±—É—Ç–∏ –ø—ñ–¥–ø–∏—Å–∞–Ω–∏–π –µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∏–º–∏ –ø—ñ–¥–ø–∏—Å–∞–º–∏ —Å—Ç–æ—Ä—ñ–Ω.');
  doc.text('9.2. –ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ñ –ø—ñ–¥–ø–∏—Å–∏ –º–∞—é—Ç—å —Ç–∞–∫—É –∂ —é—Ä–∏–¥–∏—á–Ω—É —Å–∏–ª—É, —è–∫ —ñ –≤–ª–∞—Å–Ω–æ—Ä—É—á–Ω—ñ –ø—ñ–¥–ø–∏—Å–∏.');

  doc.moveDown();
  doc.text('10. –ü–†–ê–í–û–í–ï –†–ï–ì–£–õ–Æ–í–ê–ù–ù–Ø');
  doc.text('10.1. –î–∞–Ω–∏–π –¥–æ–≥–æ–≤—ñ—Ä —É–∫–ª–∞–¥–∞—î—Ç—å—Å—è –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ –¥–æ –¶–∏–≤—ñ–ª—å–Ω–æ–≥–æ –∫–æ–¥–µ–∫—Å—É –£–∫—Ä–∞—ó–Ω–∏.');
  doc.text('10.2. –í–∏–∫–æ–Ω–∞–≤–µ—Ü—å –ø—Ä–∞—Ü—é—î —è–∫ —Ñ—ñ–∑–∏—á–Ω–∞ –æ—Å–æ–±–∞, –±–µ–∑ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –ø—ñ–¥–ø—Ä–∏—î–º–Ω–∏—Ü—å–∫–æ—ó –¥—ñ—è–ª—å–Ω–æ—Å—Ç—ñ.');
  doc.text('10.3. –û–ø–æ–¥–∞—Ç–∫—É–≤–∞–Ω–Ω—è –∑–¥—ñ–π—Å–Ω—é—î—Ç—å—Å—è –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ –¥–æ –ü–æ–¥–∞—Ç–∫–æ–≤–æ–≥–æ –∫–æ–¥–µ–∫—Å—É –£–∫—Ä–∞—ó–Ω–∏.');
  
  doc.moveDown();
  doc.text('11. –Ü–ù–®–Ü –£–ú–û–í–ò');
  doc.text('11.1. –£—Å—ñ –∑–º—ñ–Ω–∏ –¥–æ –î–æ–≥–æ–≤–æ—Ä—É –æ—Ñ–æ—Ä–º–ª—é—é—Ç—å—Å—è –ø–∏—Å—å–º–æ–≤–æ –∑–∞ –ø–æ–≥–æ–¥–∂–µ–Ω–Ω—è–º –æ–±–æ—Ö —Å—Ç–æ—Ä—ñ–Ω.');
  doc.text('11.2. –£—Å—ñ —Å–ø–æ—Ä–∏, —â–æ –≤–∏–Ω–∏–∫–∞—é—Ç—å —É –ø—Ä–æ—Ü–µ—Å—ñ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è —Ü—å–æ–≥–æ –î–æ–≥–æ–≤–æ—Ä—É, –≤–∏—Ä—ñ—à—É—é—Ç—å—Å—è —à–ª—è—Ö–æ–º –ø–µ—Ä–µ–≥–æ–≤–æ—Ä—ñ–≤, –∞ —É —Ä–∞–∑—ñ –Ω–µ–º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ ‚Äì –≤ —Å—É–¥–æ–≤–æ–º—É –ø–æ—Ä—è–¥–∫—É.');
  doc.text('11.3. –î–æ–≥–æ–≤—ñ—Ä –Ω–∞–±—É–≤–∞—î —á–∏–Ω–Ω–æ—Å—Ç—ñ –∑ –º–æ–º–µ–Ω—Ç—É –ø—ñ–¥–ø–∏—Å–∞–Ω–Ω—è —Å—Ç–æ—Ä–æ–Ω–∞–º–∏.');
  doc.text('11.4. –î–æ–≥–æ–≤—ñ—Ä –¥—ñ—î –¥–æ –ø–æ–≤–Ω–æ–≥–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è —Å—Ç–æ—Ä–æ–Ω–∞–º–∏ —Å–≤–æ—ó—Ö –∑–æ–±–æ–≤\'—è–∑–∞–Ω—å.');

  doc.moveDown();
  doc.text('12. –†–ï–ö–í–Ü–ó–ò–¢–ò –°–¢–û–†–Ü–ù');
  
  doc.text('–í–ò–ö–û–ù–ê–í–ï–¶–¨:');
  doc.text('–ó–≤—ñ—Ä–∏—á –û–ª–µ–∫—Å–∞–Ω–¥—Ä –ú–∏–∫–æ–ª–∞–π–æ–≤–∏—á');
  doc.text('–§—ñ–∑–∏—á–Ω–∞ –æ—Å–æ–±–∞');
  doc.text('–ü–∞—Å–ø–æ—Ä—Ç: —Å–µ—Ä—ñ—è –í–í ‚Ññ 123456');
  doc.text('–ö–æ–¥ –†–ù–û–ö–ü–ü: 1234567890');
  doc.text('–ê–¥—Ä–µ—Å–∞: –º. –õ—å–≤—ñ–≤, –£–∫—Ä–∞—ó–Ω–∞');
  doc.text('Email: growthtech.contact@gmail.com');
  doc.text('–¢–µ–ª–µ—Ñ–æ–Ω: +380675252300');
  
  doc.moveDown(0.5);
  doc.text('–ó–ê–ú–û–í–ù–ò–ö:');
  doc.text(`${order.user.firstName} ${order.user.lastName}`);
  doc.text('–§—ñ–∑–∏—á–Ω–∞ –æ—Å–æ–±–∞');
  doc.text(`Email: ${order.user.email}`);
  doc.text(`–¢–µ–ª–µ—Ñ–æ–Ω: ${order.user.phone}`);

  doc.moveDown();
  if (order.executorSignature && order.clientSignature) {
    doc.text('–ü—ñ–¥–ø–∏—Å–∏ —Å—Ç–æ—Ä—ñ–Ω:');
    doc.text(`–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å: ${order.executorSignature.name} (–ø—ñ–¥–ø–∏—Å–∞–Ω–æ ${formatDate(order.executorSignature.date)})`);
    doc.text(`–ó–∞–º–æ–≤–Ω–∏–∫: ${order.clientSignature.name} (–ø—ñ–¥–ø–∏—Å–∞–Ω–æ ${formatDate(order.clientSignature.date)})`);
  } else {
    doc.text('–ü—ñ–¥–ø–∏—Å–∏ —Å—Ç–æ—Ä—ñ–Ω:');
    doc.text('__________________       __________________');
    doc.text('     –í–∏–∫–æ–Ω–∞–≤–µ—Ü—å                     –ó–∞–º–æ–≤–Ω–∏–∫');
  }

  doc.moveDown();
  doc.fontSize(10).text(`–í–µ—Ä—Å—ñ—è –¥–æ–≥–æ–≤–æ—Ä—É: ${contractVersion}`, { align: 'right' });
  doc.text(`–î–∞—Ç–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è: ${formatDate(contractDate)}`, { align: 'right' });

  doc.end();

  return new Promise((resolve, reject) => {
    writeStream.on('finish', () => resolve(filePath));
    writeStream.on('error', reject);
  });
};

module.exports = { generatePDF };