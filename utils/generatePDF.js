// ðŸ“ utils/generatePDF.js
const fs = require('fs');
const PDFDocument = require('pdfkit');
const path = require('path');

const generatePDF = async (order) => {
  const doc = new PDFDocument();
  const pdfDir = path.join(__dirname, '../public/pdfs');
  const filePath = path.join(pdfDir, `contract_${order._id}.pdf`);
  
  // Ð¡Ñ‚Ð²Ð¾Ñ€Ð¸Ñ‚Ð¸ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ñ–ÑŽ ÑÐºÑ‰Ð¾ Ð½Ðµ Ñ–ÑÐ½ÑƒÑ”
  if (!fs.existsSync(pdfDir)) {
    fs.mkdirSync(pdfDir, { recursive: true });
  }
  
  const writeStream = fs.createWriteStream(filePath);

  // âœ… Ð¿Ñ–Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð½Ñ ÑˆÑ€Ð¸Ñ„Ñ‚Ñƒ Ð· ÐºÐ¸Ñ€Ð¸Ð»Ð¸Ñ†ÐµÑŽ
  doc.registerFont('DejaVu', path.join(__dirname, 'fonts/DejaVuSans.ttf'));
  doc.font('DejaVu');

  doc.pipe(writeStream);

  doc.fontSize(18).text('Ð”ÐžÐ“ÐžÐ’Ð†Ð  â„– ' + order._id, { align: 'center' });
  doc.moveDown();

  doc.fontSize(12).text(`Ð¼. Ð›ÑŒÐ²Ñ–Ð²                                                            "${new Date().toLocaleDateString()}"`, { align: 'left' });
  doc.moveDown();

  doc.text(`Ð¤ÐžÐŸ Ð—Ð²Ñ–Ñ€Ð¸Ñ‡ ÐžÐ»ÐµÐºÑÐ°Ð½Ð´Ñ€ ÐžÐ»ÐµÐºÑÐ°Ð½Ð´Ñ€Ð¾Ð²Ð¸Ñ‡, Ð½Ð°Ð´Ð°Ð»Ñ– "Ð’Ð¸ÐºÐ¾Ð½Ð°Ð²ÐµÑ†ÑŒ", Ð· Ð¾Ð´Ð½Ñ–Ñ”Ñ— ÑÑ‚Ð¾Ñ€Ð¾Ð½Ð¸, Ñ‚Ð°
${order.user.firstName} ${order.user.lastName}, Ð½Ð°Ð´Ð°Ð»Ñ– "Ð—Ð°Ð¼Ð¾Ð²Ð½Ð¸Ðº", Ð· Ñ–Ð½ÑˆÐ¾Ñ— ÑÑ‚Ð¾Ñ€Ð¾Ð½Ð¸,
ÑƒÐºÐ»Ð°Ð»Ð¸ Ñ†ÐµÐ¹ Ð”Ð¾Ð³Ð¾Ð²Ñ–Ñ€ Ð¿Ñ€Ð¾ Ð½Ð°ÑÑ‚ÑƒÐ¿Ð½Ðµ:`);

  doc.moveDown();
  doc.text('1. ÐŸÐ Ð•Ð”ÐœÐ•Ð¢ Ð”ÐžÐ“ÐžÐ’ÐžÐ Ð£');
  doc.text('1.1. Ð’Ð¸ÐºÐ¾Ð½Ð°Ð²ÐµÑ†ÑŒ Ð·Ð¾Ð±Ð¾Ð²â€™ÑÐ·ÑƒÑ”Ñ‚ÑŒÑÑ ÑÑ‚Ð²Ð¾Ñ€Ð¸Ñ‚Ð¸ Ð²ÐµÐ±-ÑÐ°Ð¹Ñ‚ Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð½Ð¾ Ð´Ð¾ Ð¾Ð±Ñ€Ð°Ð½Ð¾Ð³Ð¾ ÑˆÐ°Ð±Ð»Ð¾Ð½Ñƒ Ð—Ð°Ð¼Ð¾Ð²Ð½Ð¸ÐºÐ¾Ð¼:');
  doc.text(`    - ÐžÐ±Ñ€Ð°Ð½Ð¸Ð¹ ÑˆÐ°Ð±Ð»Ð¾Ð½: ${order.selectedTemplate}`);

  doc.moveDown();
  doc.text('2. Ð¡Ð¢Ð ÐžÐšÐ˜ Ð’Ð˜ÐšÐžÐÐÐÐÐ¯');
  doc.text('2.1. Ð’Ð¸ÐºÐ¾Ð½Ð°Ð²ÐµÑ†ÑŒ Ð·Ð¾Ð±Ð¾Ð²â€™ÑÐ·ÑƒÑ”Ñ‚ÑŒÑÑ Ð²Ð¸ÐºÐ¾Ð½Ð°Ñ‚Ð¸ Ñ€Ð¾Ð±Ð¾Ñ‚Ð¸ Ð¿Ñ€Ð¾Ñ‚ÑÐ³Ð¾Ð¼ 14-30 ÐºÐ°Ð»ÐµÐ½Ð´Ð°Ñ€Ð½Ð¸Ñ… Ð´Ð½Ñ–Ð² Ð· Ð¼Ð¾Ð¼ÐµÐ½Ñ‚Ñƒ Ð¿Ð¾Ð³Ð¾Ð´Ð¶ÐµÐ½Ð½Ñ Ð²ÑÑ–Ñ… Ð¼Ð°Ñ‚ÐµÑ€Ñ–Ð°Ð»Ñ–Ð².');

  doc.moveDown();
  doc.text('3. Ð’ÐÐ Ð¢Ð†Ð¡Ð¢Ð¬ Ð¢Ð ÐžÐŸÐ›ÐÐ¢Ð');
  doc.text('3.1. Ð’Ð°Ñ€Ñ‚Ñ–ÑÑ‚ÑŒ Ñ€Ð¾Ð±Ñ–Ñ‚ Ð²Ð¸Ð·Ð½Ð°Ñ‡Ð°Ñ”Ñ‚ÑŒÑÑ Ð·Ð° Ð´Ð¾Ð¼Ð¾Ð²Ð»ÐµÐ½Ñ–ÑÑ‚ÑŽ ÑÑ‚Ð¾Ñ€Ñ–Ð½.');
  doc.text('3.2. ÐžÐ¿Ð»Ð°Ñ‚Ð° Ð·Ð´Ñ–Ð¹ÑÐ½ÑŽÑ”Ñ‚ÑŒÑÑ Ñƒ Ð´Ð²Ð° ÐµÑ‚Ð°Ð¿Ð¸: 30% Ð¿ÐµÑ€ÐµÐ´Ð¾Ð¿Ð»Ð°Ñ‚Ð°, 70% Ð¿Ñ–ÑÐ»Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð½Ñ Ñ€Ð¾Ð±Ñ–Ñ‚.');
  doc.text('3.3. Ð£ Ñ€Ð°Ð·Ñ– Ð·Ð°Ñ‚Ñ€Ð¸Ð¼ÐºÐ¸ Ð¿Ð»Ð°Ñ‚ÐµÐ¶Ñ–Ð², ÑÑ‚Ñ€Ð¾ÐºÐ¸ Ð²Ð¸ÐºÐ¾Ð½Ð°Ð½Ð½Ñ Ñ€Ð¾Ð±Ñ–Ñ‚ Ð¼Ð¾Ð¶ÑƒÑ‚ÑŒ Ð±ÑƒÑ‚Ð¸ Ð¿ÐµÑ€ÐµÐ³Ð»ÑÐ½ÑƒÑ‚Ñ–.');

  doc.moveDown();
  doc.text(`'4. ÐŸÐ ÐÐ’Ð Ð¢Ð ÐžÐ‘ÐžÐ’'Ð¯Ð—ÐšÐ˜ Ð¡Ð¢ÐžÐ Ð†Ð'`);
  doc.text('4.1. Ð’Ð¸ÐºÐ¾Ð½Ð°Ð²ÐµÑ†ÑŒ Ð¼Ð°Ñ” Ð¿Ñ€Ð°Ð²Ð¾ Ð²Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÐ²Ð°Ñ‚Ð¸ ÑÑ‚Ð²Ð¾Ñ€ÐµÐ½Ð¸Ð¹ ÑÐ°Ð¹Ñ‚ Ñƒ ÑÐ²Ð¾Ñ”Ð¼Ñƒ Ð¿Ð¾Ñ€Ñ‚Ñ„Ð¾Ð»Ñ–Ð¾.');
  doc.text('4.2. Ð—Ð°Ð¼Ð¾Ð²Ð½Ð¸Ðº Ð·Ð¾Ð±Ð¾Ð²â€™ÑÐ·ÑƒÑ”Ñ‚ÑŒÑÑ Ð½Ð°Ð´Ð°Ñ‚Ð¸ Ð½ÐµÐ¾Ð±Ñ…Ñ–Ð´Ð½Ñƒ Ñ–Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ñ–ÑŽ Ñ‚Ð° Ð¼Ð°Ñ‚ÐµÑ€Ñ–Ð°Ð»Ð¸ Ð´Ð»Ñ ÑÑ‚Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ ÑÐ°Ð¹Ñ‚Ñƒ.');

  doc.moveDown();
  doc.text('5. Ð¤ÐžÐ Ð¡-ÐœÐÐ–ÐžÐ ');
  doc.text('5.1. Ð¡Ñ‚Ð¾Ñ€Ð¾Ð½Ð¸ Ð·Ð²Ñ–Ð»ÑŒÐ½ÑÑŽÑ‚ÑŒÑÑ Ð²Ñ–Ð´ Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ð»ÑŒÐ½Ð¾ÑÑ‚Ñ– Ð·Ð° Ñ‡Ð°ÑÑ‚ÐºÐ¾Ð²Ðµ Ð°Ð±Ð¾ Ð¿Ð¾Ð²Ð½Ðµ Ð½ÐµÐ²Ð¸ÐºÐ¾Ð½Ð°Ð½Ð½Ñ Ð·Ð¾Ð±Ð¾Ð²â€™ÑÐ·Ð°Ð½ÑŒ Ð·Ð° Ñ†Ð¸Ð¼ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð¾Ð¼ Ñƒ Ñ€Ð°Ð·Ñ– Ð½Ð°ÑÑ‚Ð°Ð½Ð½Ñ Ñ„Ð¾Ñ€Ñ-Ð¼Ð°Ð¶Ð¾Ñ€Ð½Ð¸Ñ… Ð¾Ð±ÑÑ‚Ð°Ð²Ð¸Ð½.');
  doc.text('5.2. Ð”Ð¾ Ñ„Ð¾Ñ€Ñ-Ð¼Ð°Ð¶Ð¾Ñ€Ð½Ð¸Ñ… Ð¾Ð±ÑÑ‚Ð°Ð²Ð¸Ð½ Ð½Ð°Ð»ÐµÐ¶Ð°Ñ‚ÑŒ: Ð¿Ð¾Ð¶ÐµÐ¶Ñ–, Ð¿Ð¾Ð²ÐµÐ½Ñ–, Ð·ÐµÐ¼Ð»ÐµÑ‚Ñ€ÑƒÑÐ¸, Ð²Ñ–Ð¹Ð½Ð°, ÑÑ‚Ñ€Ð°Ð¹ÐºÐ¸, Ð°ÐºÑ‚Ð¸ Ð´ÐµÑ€Ð¶Ð°Ð²Ð½Ð¸Ñ… Ð¾Ñ€Ð³Ð°Ð½Ñ–Ð² Ñ‚Ð¾Ñ‰Ð¾.');
  doc.text('5.3. Ð¡Ñ‚Ð¾Ñ€Ð¾Ð½Ð°, ÑÐºÐ° Ð½Ðµ Ð¼Ð¾Ð¶Ðµ Ð²Ð¸ÐºÐ¾Ð½Ð°Ñ‚Ð¸ ÑÐ²Ð¾Ñ— Ð·Ð¾Ð±Ð¾Ð²â€™ÑÐ·Ð°Ð½Ð½Ñ, Ð¿Ð¾Ð²Ð¸Ð½Ð½Ð° Ð¿Ð¸ÑÑŒÐ¼Ð¾Ð²Ð¾ Ð¿Ð¾Ð²Ñ–Ð´Ð¾Ð¼Ð¸Ñ‚Ð¸ Ñ–Ð½ÑˆÑƒ ÑÑ‚Ð¾Ñ€Ð¾Ð½Ñƒ Ð¿Ñ€Ð¾Ñ‚ÑÐ³Ð¾Ð¼ 5 Ð´Ð½Ñ–Ð².');

  doc.moveDown();
  doc.text('6. ÐšÐžÐÐ¤Ð†Ð”Ð•ÐÐ¦Ð†Ð™ÐÐ†Ð¡Ð¢Ð¬');
  doc.text('6.1. Ð¡Ñ‚Ð¾Ñ€Ð¾Ð½Ð¸ Ð·Ð¾Ð±Ð¾Ð²â€™ÑÐ·ÑƒÑŽÑ‚ÑŒÑÑ Ð·Ð±ÐµÑ€Ñ–Ð³Ð°Ñ‚Ð¸ ÐºÐ¾Ð½Ñ„Ñ–Ð´ÐµÐ½Ñ†Ñ–Ð¹Ð½Ñ–ÑÑ‚ÑŒ Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°Ð½Ð¾Ñ— Ð² Ð¿Ñ€Ð¾Ñ†ÐµÑÑ– Ð²Ð¸ÐºÐ¾Ð½Ð°Ð½Ð½Ñ Ñ†ÑŒÐ¾Ð³Ð¾ Ð”Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ñƒ Ñ–Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ñ–Ñ—.');

  doc.moveDown();
  doc.text('7. Ð’Ð†Ð”ÐŸÐžÐ’Ð†Ð”ÐÐ›Ð¬ÐÐ†Ð¡Ð¢Ð¬ Ð¡Ð¢ÐžÐ Ð†Ð');
  doc.text('7.1. Ð£ Ñ€Ð°Ð·Ñ– Ð½ÐµÐ²Ð¸ÐºÐ¾Ð½Ð°Ð½Ð½Ñ ÑƒÐ¼Ð¾Ð² Ñ†ÑŒÐ¾Ð³Ð¾ Ð”Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ñƒ Ð²Ð¸Ð½Ð½Ð° ÑÑ‚Ð¾Ñ€Ð¾Ð½Ð° Ð½ÐµÑÐµ Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ð»ÑŒÐ½Ñ–ÑÑ‚ÑŒ Ð·Ð³Ñ–Ð´Ð½Ð¾ Ð· Ñ‡Ð¸Ð½Ð½Ð¸Ð¼ Ð·Ð°ÐºÐ¾Ð½Ð¾Ð´Ð°Ð²ÑÑ‚Ð²Ð¾Ð¼ Ð£ÐºÑ€Ð°Ñ—Ð½Ð¸.');

  doc.moveDown();
  doc.text('8. Ð†ÐÐ¨Ð† Ð£ÐœÐžÐ’Ð˜');
  doc.text('8.1. Ð£ÑÑ– Ð·Ð¼Ñ–Ð½Ð¸ Ð´Ð¾ Ð”Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ñƒ Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÑŽÑŽÑ‚ÑŒÑÑ Ð¿Ð¸ÑÑŒÐ¼Ð¾Ð²Ð¾ Ð·Ð° Ð¿Ð¾Ð³Ð¾Ð´Ð¶ÐµÐ½Ð½ÑÐ¼ Ð¾Ð±Ð¾Ñ… ÑÑ‚Ð¾Ñ€Ñ–Ð½.');
  doc.text('8.2. Ð£ÑÑ– ÑÐ¿Ð¾Ñ€Ð¸, Ñ‰Ð¾ Ð²Ð¸Ð½Ð¸ÐºÐ°ÑŽÑ‚ÑŒ Ñƒ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ– Ð²Ð¸ÐºÐ¾Ð½Ð°Ð½Ð½Ñ Ñ†ÑŒÐ¾Ð³Ð¾ Ð”Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ñƒ, Ð²Ð¸Ñ€Ñ–ÑˆÑƒÑŽÑ‚ÑŒÑÑ ÑˆÐ»ÑÑ…Ð¾Ð¼ Ð¿ÐµÑ€ÐµÐ³Ð¾Ð²Ð¾Ñ€Ñ–Ð², Ð° Ñƒ Ñ€Ð°Ð·Ñ– Ð½ÐµÐ¼Ð¾Ð¶Ð»Ð¸Ð²Ð¾ÑÑ‚Ñ– â€“ Ð² ÑÑƒÐ´Ð¾Ð²Ð¾Ð¼Ñƒ Ð¿Ð¾Ñ€ÑÐ´ÐºÑƒ.');

  doc.moveDown();
  doc.text('9. Ð Ð•ÐšÐ’Ð†Ð—Ð˜Ð¢Ð˜ Ð¡Ð¢ÐžÐ Ð†Ð');
  doc.text('Ð’Ð¸ÐºÐ¾Ð½Ð°Ð²ÐµÑ†ÑŒ: Ð¤ÐžÐŸ Ð—Ð²Ñ–Ñ€Ð¸Ñ‡ ÐžÐ»ÐµÐºÑÐ°Ð½Ð´Ñ€ ÐžÐ»ÐµÐºÑÐ°Ð½Ð´Ñ€Ð¾Ð²Ð¸Ñ‡, Ð›ÑŒÐ²Ñ–Ð², Ð£ÐºÑ€Ð°Ñ—Ð½Ð°');
  doc.text(`Ð—Ð°Ð¼Ð¾Ð²Ð½Ð¸Ðº: ${order.user.firstName} ${order.user.lastName}, email: ${order.user.email}, Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½: ${order.user.phone}`);

  doc.moveDown();
  doc.text('ÐŸÑ–Ð´Ð¿Ð¸ÑÐ¸ ÑÑ‚Ð¾Ñ€Ñ–Ð½:');
  doc.text('__________________       __________________');
  doc.text('     Ð’Ð¸ÐºÐ¾Ð½Ð°Ð²ÐµÑ†ÑŒ                     Ð—Ð°Ð¼Ð¾Ð²Ð½Ð¸Ðº');

  doc.end();

  return new Promise((resolve, reject) => {
    writeStream.on('finish', () => resolve(filePath));
    writeStream.on('error', reject);
  });
};

module.exports = { generatePDF };
